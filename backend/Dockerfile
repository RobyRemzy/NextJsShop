# :whale2:
FROM node:10.16-stretch-slim

WORKDIR /usr/src/app

COPY package*.json yarn.lock ./

RUN yarn install --frozen-lockfile --production && yarn cache clean
RUN yarn global add prisma@1.30.1

ARG PRISMA_ENDPOINT="http://localhost:4466"
ENV ENV_PRISMA_ENDPOINT=$PRISMA_ENDPOINT

ARG PRISMA_EP_SERVICE=test
ENV ENV_PRISMA_EP_SERVICE=$PRISMA_EP_SERVICE

ARG PRISMA_EP_STAGE=dev
ENV ENV_PRISMA_EP_STAGE=$PRISMA_EP_STAGE

ARG PRISMA_PORT=4466
RUN echo "listening Prisma on $PRISMA_ENDPOINT/$PRISMA_EP_SERVICE/$PRISMA_EP_STAGE"
ENV ENV_PRISMA_PORT=$PRISMA_PORT

ARG PRISMA_MANAGEMENT_API_SECRET=secret
ENV ENV_PRISMA_MANAGEMENT_API_SECRET=$PRISMA_MANAGEMENT_API_SECRET

ARG PRISMA_MANAGEMENT_API_SECRET=secret
ENV ENV_PRISMA_MANAGEMENT_API_SECRET=$PRISMA_MANAGEMENT_API_SECRET

ARG PRISMA_SECRET=secret
ENV ENV_PRISMA_SECRET=$PRISMA_SECRET

ARG PRISMA_DB_USER=postgres
ENV ENV_PRISMA_DB_USER=$PRISMA_DB_USER

ARG PRISMA_DB_USER_PSW=postgres
ENV ENV_PRISMA_DB_USER_PSW=$PRISMA_DB_USER_PSW

ARG YOGA_URL="http://localhost"
ENV ENV_YOGA_URL=$YOGA_URL

ARG YOGA_PORT=8877
RUN echo "listening Yoga server on $YOGA_URL:YOGA_PORT"
ENV ENV_YOGA_PORT=$YOGA_PORT

ARG FRONTEND_URL="http://localhost:7788"
RUN echo "app is running on $FRONTEND_URL"
ENV ENV_FRONTEND_URL=$FRONTEND_URL

ARG APP_SECRET=secret
ENV ENV_APP_SECRET=$APP_SECRET

ARG STRIPE_SECRET=secret
ENV ENV_STRIPE_SECRET=$STRIPE_SECRET

ARG API_INSEE_TOKEN=inseetoken
ENV ENV_API_INSEE_TOKEN=$API_INSEE_TOKEN

ARG MAIL_HOST=localhost
ENV ENV_ MAIL_HOST=$MAIL_HOST

ARG MAIL_PORT=465
ENV ENV_MAIL_PORT=$MAIL_PORT

ARG MAIL_USER=user@email.com
ENV ENV_MAIL_USER=$MAIL_USER

ARG MAIL_PASS=secret
ENV ENV_MAIL_PASS=$MAIL_PASS

ARG MAIL_SENDER="User <user@email.com>"
ENV ENV_MAIL_SENDER=$MAIL_SENDER

ARG MAIL_BCC="user@email.com, user2@email.com"
ENV ENV_MAIL_BCC=$MAIL_BCC

ARG MAIL_OBJ="mail object"
ENV MAIL_OBJ=$MAIL_OBJ

COPY . .

EXPOSE 8877

CMD ["yarn", "start"]
